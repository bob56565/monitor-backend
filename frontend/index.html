<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MONITOR v3.2 - Health Intelligence Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        body { background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%); min-height: 100vh; }
        .glass { background: rgba(255,255,255,0.05); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); }
        .glass-dark { background: rgba(0,0,0,0.3); backdrop-filter: blur(10px); }
        .input-field { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); transition: all 0.3s; }
        .input-field:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.2); outline: none; }
        .btn-primary { background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); transition: all 0.3s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(59,130,246,0.4); }
        .risk-low, .risk-normal, .risk-optimal { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .risk-moderate, .risk-borderline { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .risk-elevated { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
        .risk-high { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .proxy-card { background: linear-gradient(135deg, rgba(139,92,246,0.2) 0%, rgba(236,72,153,0.2) 100%); border: 1px solid rgba(139,92,246,0.3); }
        .tier-direct { border-left: 4px solid #10b981; }
        .tier-derived { border-left: 4px solid #3b82f6; }
        .tier-proxy { border-left: 4px solid #8b5cf6; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-fade { animation: fadeIn 0.5s ease-out forwards; }
        .loading { animation: pulse 1.5s infinite; }
        .tab-active { background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%); }
    </style>
</head>
<body class="text-white">
    <header class="fixed top-0 left-0 right-0 z-50 glass-dark">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center font-bold text-lg">M</div>
                <div>
                    <h1 class="font-bold text-xl">MONITOR <span class="text-sm text-purple-400">v3.2</span></h1>
                    <p class="text-xs text-gray-400">Cascade Inference + Proxy Intelligence</p>
                </div>
            </div>
            <div class="flex items-center gap-4 text-sm">
                <span id="apiStatus" class="text-green-400">‚óè Live</span>
                <select id="modeSelect" class="bg-gray-800 border border-gray-700 rounded px-2 py-1 text-sm">
                    <option value="a2">A2 Experience</option>
                    <option value="clinician">Clinician Mode</option>
                    <option value="consumer">Consumer Mode</option>
                    <option value="standard">Standard</option>
                </select>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 pt-20 pb-12">
        <div class="grid lg:grid-cols-4 gap-6">
            <!-- Input Panel -->
            <div class="lg:col-span-1">
                <div class="glass rounded-2xl p-4 sticky top-20">
                    <h3 class="font-semibold mb-3">üì• Biomarkers</h3>
                    <form id="biomarkerForm" class="space-y-3 text-sm">
                        <div class="space-y-2">
                            <label class="text-xs text-gray-400">LIPID</label>
                            <input name="total_cholesterol" type="number" placeholder="Total Cholesterol" class="input-field w-full px-3 py-2 rounded-lg text-white">
                            <input name="hdl" type="number" placeholder="HDL" class="input-field w-full px-3 py-2 rounded-lg text-white">
                            <input name="triglycerides" type="number" placeholder="Triglycerides" class="input-field w-full px-3 py-2 rounded-lg text-white">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs text-gray-400">GLYCEMIC</label>
                            <input name="fasting_glucose" type="number" placeholder="Fasting Glucose" class="input-field w-full px-3 py-2 rounded-lg text-white">
                            <input name="fasting_insulin" type="number" placeholder="Fasting Insulin" class="input-field w-full px-3 py-2 rounded-lg text-white">
                            <input name="hba1c" type="number" step="0.1" placeholder="HbA1c %" class="input-field w-full px-3 py-2 rounded-lg text-white">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs text-gray-400">KIDNEY/LIVER</label>
                            <input name="creatinine" type="number" step="0.1" placeholder="Creatinine" class="input-field w-full px-3 py-2 rounded-lg text-white">
                            <input name="alt" type="number" placeholder="ALT" class="input-field w-full px-3 py-2 rounded-lg text-white">
                            <input name="ast" type="number" placeholder="AST" class="input-field w-full px-3 py-2 rounded-lg text-white">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs text-gray-400">INFLAMMATORY</label>
                            <input name="hscrp" type="number" step="0.1" placeholder="hs-CRP" class="input-field w-full px-3 py-2 rounded-lg text-white">
                            <input name="ferritin" type="number" placeholder="Ferritin" class="input-field w-full px-3 py-2 rounded-lg text-white">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs text-gray-400">VITALS/BODY</label>
                            <input name="sbp" type="number" placeholder="Systolic BP" class="input-field w-full px-3 py-2 rounded-lg text-white">
                            <input name="dbp" type="number" placeholder="Diastolic BP" class="input-field w-full px-3 py-2 rounded-lg text-white">
                            <input name="weight_kg" type="number" placeholder="Weight (kg)" class="input-field w-full px-3 py-2 rounded-lg text-white">
                            <input name="height_cm" type="number" placeholder="Height (cm)" class="input-field w-full px-3 py-2 rounded-lg text-white">
                            <input name="waist_cm" type="number" placeholder="Waist (cm)" class="input-field w-full px-3 py-2 rounded-lg text-white">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs text-gray-400">DEMOGRAPHICS</label>
                            <input name="age" type="number" placeholder="Age" class="input-field w-full px-3 py-2 rounded-lg text-white">
                            <label class="flex items-center gap-2 text-gray-300">
                                <input name="is_female" type="checkbox" class="rounded"> Female
                            </label>
                        </div>
                    </form>
                    <div class="mt-4 space-y-2">
                        <button onclick="analyze()" id="analyzeBtn" class="w-full btn-primary text-white font-semibold py-3 rounded-xl">
                            üî¨ Analyze
                        </button>
                        <button onclick="loadDemo()" class="w-full glass hover:bg-white/10 py-2 rounded-xl text-sm">
                            üìã Load Demo Data
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Panel -->
            <div class="lg:col-span-3 space-y-4">
                <!-- Executive Summary (NEW) -->
                <div id="summaryPanel" class="hidden">
                    <div class="glass rounded-2xl p-5 border-l-4 border-purple-500">
                        <h3 class="font-bold text-lg mb-3">üìã Executive Summary</h3>
                        <div id="summaryHeadline" class="text-2xl font-bold text-purple-400 mb-4"></div>
                        <div class="grid md:grid-cols-3 gap-4">
                            <div>
                                <h4 class="text-sm text-gray-400 mb-2">Key Findings</h4>
                                <div id="keyFindings" class="space-y-2"></div>
                            </div>
                            <div>
                                <h4 class="text-sm text-gray-400 mb-2">Action Items</h4>
                                <div id="actionItems" class="space-y-2"></div>
                            </div>
                            <div>
                                <h4 class="text-sm text-gray-400 mb-2">Data Quality</h4>
                                <div id="dataQuality" class="space-y-2"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Bar -->
                <div id="statsPanel" class="hidden glass rounded-2xl p-4">
                    <div class="grid grid-cols-5 gap-4 text-center">
                        <div><div class="text-2xl font-bold text-blue-400" id="statInputs">0</div><div class="text-xs text-gray-400">Inputs</div></div>
                        <div><div class="text-2xl font-bold text-purple-400" id="statCalculated">0</div><div class="text-xs text-gray-400">Derived</div></div>
                        <div><div class="text-2xl font-bold text-pink-400" id="statProxies">0</div><div class="text-xs text-gray-400">Proxies</div></div>
                        <div><div class="text-2xl font-bold text-green-400" id="statTotal">0</div><div class="text-xs text-gray-400">Total</div></div>
                        <div><div class="text-2xl font-bold" id="statConstraints">‚úì</div><div class="text-xs text-gray-400">Validation</div></div>
                    </div>
                </div>

                <!-- Coverage Map (NEW) -->
                <div id="coveragePanel" class="hidden glass rounded-2xl p-4">
                    <h4 class="font-semibold mb-3">üìä Coverage Map <span class="text-sm text-gray-400" id="coveragePercent"></span></h4>
                    <div id="coverageMap" class="grid grid-cols-4 gap-2 text-xs"></div>
                </div>

                <!-- Proxy Outputs (NEW - THE MAGIC) -->
                <div id="proxyPanel" class="hidden">
                    <h3 class="font-bold text-lg mb-3 flex items-center gap-2">
                        <span class="text-2xl">‚ú®</span> Physiological Proxies
                        <span class="text-xs text-purple-400 font-normal">(Inferred States)</span>
                    </h3>
                    <div id="proxyResults" class="grid md:grid-cols-2 gap-3"></div>
                </div>

                <!-- Derived Outputs -->
                <div id="derivedPanel" class="hidden">
                    <h3 class="font-bold text-lg mb-3">üìà Derived Calculations</h3>
                    <div id="derivedResults" class="grid md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
                </div>

                <!-- Unlock Opportunities (NEW) -->
                <div id="unlockPanel" class="hidden glass rounded-2xl p-4">
                    <h4 class="font-semibold mb-3">üîì Add One Input to Unlock</h4>
                    <div id="unlockList" class="grid md:grid-cols-2 gap-2"></div>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="glass rounded-2xl p-12 text-center">
                    <div class="text-6xl mb-4">üß¨</div>
                    <p class="text-xl text-gray-300">Enter biomarkers or load demo</p>
                    <p class="text-sm text-gray-500 mt-2">Experience cascade inference + proxy intelligence</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        const API_URL = 'https://monitor-api.abedelhamdan.workers.dev';

        function loadDemo() {
            const demo = {
                total_cholesterol: 220, hdl: 42, triglycerides: 185,
                fasting_glucose: 108, fasting_insulin: 15,
                age: 45, creatinine: 1.1, hscrp: 2.5, ferritin: 180,
                weight_kg: 85, height_cm: 175, waist_cm: 98,
                sbp: 138, dbp: 88, alt: 35, ast: 28
            };
            for (const [k, v] of Object.entries(demo)) {
                const el = document.querySelector(`[name="${k}"]`);
                if (el) el.value = v;
            }
            analyze();
        }

        async function analyze() {
            const btn = document.getElementById('analyzeBtn');
            btn.innerHTML = '<span class="loading">Analyzing...</span>';
            btn.disabled = true;

            const form = document.getElementById('biomarkerForm');
            const data = {};
            new FormData(form).forEach((v, k) => {
                if (v && k !== 'is_female') data[k] = parseFloat(v);
            });
            if (form.querySelector('[name="is_female"]')?.checked) data.is_female = true;

            if (Object.keys(data).length === 0) {
                alert('Enter at least one biomarker');
                btn.innerHTML = 'üî¨ Analyze';
                btn.disabled = false;
                return;
            }

            try {
                const mode = document.getElementById('modeSelect').value;
                const res = await fetch(`${API_URL}/analyze?mode=${mode}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                displayResults(result, mode);
            } catch (e) {
                alert('Error: ' + e.message);
            }

            btn.innerHTML = 'üî¨ Analyze';
            btn.disabled = false;
        }

        function displayResults(result, mode) {
            document.getElementById('emptyState').classList.add('hidden');
            
            // Stats
            document.getElementById('statsPanel').classList.remove('hidden');
            document.getElementById('statInputs').textContent = result.inputs || result.cascade_result?.inputs || 0;
            
            const derived = result.derived || result.cascade_result?.derived || [];
            const proxies = derived.filter(d => d.name.includes('proxy') || d.name.includes('likelihood') || d.name.includes('state'));
            const nonProxies = derived.filter(d => !d.name.includes('proxy') && !d.name.includes('likelihood') && !d.name.includes('state'));
            
            document.getElementById('statCalculated').textContent = nonProxies.length;
            document.getElementById('statProxies').textContent = proxies.length;
            document.getElementById('statTotal').textContent = result.total || result.cascade_result?.total || derived.length;
            
            const constraints = result.constraints || result.cascade_result?.constraints;
            if (constraints) {
                const status = constraints.status === 'valid' ? '‚úì' : constraints.status === 'review' ? '‚ö†' : '‚úó';
                const color = constraints.status === 'valid' ? 'text-green-400' : constraints.status === 'review' ? 'text-yellow-400' : 'text-red-400';
                document.getElementById('statConstraints').innerHTML = `<span class="${color}">${status}</span>`;
            }

            // Executive Summary (A2 mode)
            if (result.executive_summary) {
                document.getElementById('summaryPanel').classList.remove('hidden');
                document.getElementById('summaryHeadline').textContent = result.executive_summary.headline;
                
                let findingsHtml = '';
                (result.executive_summary.key_findings || []).forEach(f => {
                    const color = f.severity === 'normal' ? 'text-green-400' : f.severity === 'warning' ? 'text-yellow-400' : 'text-orange-400';
                    findingsHtml += `<div class="glass-dark rounded p-2 ${color} text-sm">${f.finding}</div>`;
                });
                document.getElementById('keyFindings').innerHTML = findingsHtml || '<div class="text-gray-500 text-sm">No concerns</div>';
                
                let actionsHtml = '';
                (result.executive_summary.action_items || []).forEach(a => {
                    actionsHtml += `<div class="glass-dark rounded p-2 text-sm">${a.action}</div>`;
                });
                document.getElementById('actionItems').innerHTML = actionsHtml || '<div class="text-gray-500 text-sm">No actions needed</div>';
                
                const dq = result.data_quality || {};
                document.getElementById('dataQuality').innerHTML = `
                    <div class="glass-dark rounded p-2 text-sm">Status: <span class="${dq.status === 'valid' ? 'text-green-400' : 'text-yellow-400'}">${dq.status || 'valid'}</span></div>
                    <div class="glass-dark rounded p-2 text-sm">Issues: ${dq.issues || 0}</div>
                `;
            } else {
                document.getElementById('summaryPanel').classList.add('hidden');
            }

            // Coverage Map
            if (result.coverage) {
                document.getElementById('coveragePanel').classList.remove('hidden');
                document.getElementById('coveragePercent').textContent = `(${result.coverage.completeness}% complete)`;
                let covHtml = '';
                for (const [cat, data] of Object.entries(result.coverage.by_category || {})) {
                    const pct = Math.round(data.completeness * 100);
                    const color = pct > 70 ? 'bg-green-500' : pct > 30 ? 'bg-yellow-500' : 'bg-gray-600';
                    covHtml += `<div class="glass-dark rounded p-2">
                        <div class="flex justify-between mb-1"><span>${cat}</span><span>${pct}%</span></div>
                        <div class="h-1 bg-gray-700 rounded"><div class="h-1 ${color} rounded" style="width:${pct}%"></div></div>
                    </div>`;
                }
                document.getElementById('coverageMap').innerHTML = covHtml;
            } else {
                document.getElementById('coveragePanel').classList.add('hidden');
            }

            // Proxy Outputs (THE MAGIC)
            if (proxies.length > 0) {
                document.getElementById('proxyPanel').classList.remove('hidden');
                let proxyHtml = '';
                proxies.forEach(p => {
                    const val = p.value;
                    const state = typeof val === 'object' ? (val.state || val.likelihood || JSON.stringify(val)) : val;
                    const stateColor = getStateColor(state);
                    const conf = typeof p.confidence === 'object' ? p.confidence.score : p.confidence;
                    const labAnchor = val?.lab_anchor;
                    
                    proxyHtml += `<div class="proxy-card rounded-xl p-4 animate-fade">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-sm text-gray-300">${formatName(p.name)}</span>
                            <span class="px-2 py-1 rounded text-xs font-bold ${stateColor}">${state}</span>
                        </div>
                        ${val?.note ? `<p class="text-xs text-gray-400 mb-2">${val.note}</p>` : ''}
                        ${labAnchor ? `<div class="text-xs text-purple-300">üî¨ Lab anchor: ${labAnchor.test || labAnchor.tests?.join(', ')}</div>` : ''}
                        <div class="mt-2 flex items-center gap-2">
                            <div class="flex-1 bg-gray-700 rounded h-1"><div class="bg-purple-500 h-1 rounded" style="width:${Math.round((conf || 0.7) * 100)}%"></div></div>
                            <span class="text-xs text-gray-500">${Math.round((conf || 0.7) * 100)}%</span>
                        </div>
                    </div>`;
                });
                document.getElementById('proxyResults').innerHTML = proxyHtml;
            } else {
                document.getElementById('proxyPanel').classList.add('hidden');
            }

            // Derived Outputs
            if (nonProxies.length > 0) {
                document.getElementById('derivedPanel').classList.remove('hidden');
                let derivedHtml = '';
                nonProxies.slice(0, 20).forEach(d => {
                    const val = typeof d.value === 'object' ? JSON.stringify(d.value) : (typeof d.value === 'number' ? d.value.toFixed(2) : d.value);
                    const risk = d.interpretation?.risk;
                    const riskClass = risk ? `risk-${risk}` : 'bg-gray-600';
                    const conf = typeof d.confidence === 'object' ? d.confidence.score : d.confidence;
                    
                    derivedHtml += `<div class="glass-dark rounded-lg p-3 tier-derived">
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-gray-400">${formatName(d.name)}</span>
                            ${risk ? `<span class="px-2 py-0.5 rounded text-xs ${riskClass}">${risk}</span>` : ''}
                        </div>
                        <div class="text-lg font-bold text-blue-400">${val}</div>
                        <div class="text-xs text-gray-500">${Math.round((conf || 0.8) * 100)}% confidence</div>
                    </div>`;
                });
                document.getElementById('derivedResults').innerHTML = derivedHtml;
            } else {
                document.getElementById('derivedPanel').classList.add('hidden');
            }

            // Unlock Opportunities
            const unlocks = result.unlock_opportunities || result.suggestions;
            if (unlocks && unlocks.length > 0) {
                document.getElementById('unlockPanel').classList.remove('hidden');
                let unlockHtml = '';
                unlocks.slice(0, 6).forEach(u => {
                    const input = u.input || u.missing;
                    const count = u.unlocks_count || 1;
                    unlockHtml += `<div class="glass-dark rounded p-2 text-sm">
                        <span class="text-green-400">+ ${input}</span> ‚Üí unlocks ${count} output(s)
                    </div>`;
                });
                document.getElementById('unlockList').innerHTML = unlockHtml;
            } else {
                document.getElementById('unlockPanel').classList.add('hidden');
            }
        }

        function formatName(name) {
            return name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function getStateColor(state) {
            const s = String(state).toLowerCase();
            if (s.includes('optimal') || s.includes('normal') || s.includes('low') || s.includes('good') || s.includes('adequate') || s.includes('sensitive') || s.includes('robust') || s.includes('unlikely')) return 'bg-green-500';
            if (s.includes('elevated') || s.includes('high') || s.includes('resistant') || s.includes('deficient') || s.includes('likely')) return 'bg-orange-500';
            if (s.includes('moderate') || s.includes('possible') || s.includes('borderline') || s.includes('indeterminate')) return 'bg-yellow-500';
            return 'bg-gray-500';
        }

        // Check API on load
        fetch(API_URL).then(r => r.json()).then(d => {
            document.getElementById('apiStatus').innerHTML = `<span class="text-green-400">‚óè v${d.version?.split(' ')[0] || '3.2'}</span>`;
        }).catch(() => {
            document.getElementById('apiStatus').innerHTML = '<span class="text-red-400">‚óè Offline</span>';
        });
    </script>
</body>
</html>
