<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitor Health ‚Äî Premium Insights v3.7.0</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --bg: #FAF9F7;
      --card: #FFFFFF;
      --text: #2D3436;
      --muted: #636e72;
      --line: rgba(45,52,54,0.1);
      --sage: #4A7C59;
      --sage-light: rgba(74,124,89,0.08);
      --coral: #E07A5F;
      --coral-light: rgba(224,122,95,0.08);
      --blue: #4A6FA5;
      --blue-light: rgba(74,111,165,0.08);
      --purple: #7B68EE;
      --purple-light: rgba(123,104,238,0.08);
      --gold: #D4A853;
      --gold-light: rgba(212,168,83,0.1);
      --shadow: 0 4px 24px rgba(0,0,0,0.06);
      --radius: 20px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 24px; }
    
    /* Header */
    header {
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--line);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-inner { height: 72px; display: flex; align-items: center; justify-content: space-between; }
    .brand { display: flex; align-items: center; gap: 12px; font-weight: 600; font-size: 18px; }
    .brand-mark {
      width: 40px; height: 40px; border-radius: 12px;
      background: linear-gradient(135deg, var(--sage), #86BFA0);
      color: white; display: grid; place-items: center; font-weight: 700;
    }
    .nav { display: flex; gap: 20px; align-items: center; }
    .nav a { color: var(--muted); text-decoration: none; font-size: 14px; font-weight: 500; }
    .nav a:hover { color: var(--text); }
    .version { background: var(--sage-light); color: var(--sage); padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; }

    /* Hero */
    .hero { padding: 64px 0 32px; }
    .eyebrow {
      display: inline-flex; align-items: center; gap: 8px;
      background: var(--sage-light); border: 1px solid rgba(74,124,89,0.2);
      color: var(--sage); padding: 8px 16px; border-radius: 24px;
      font-size: 12px; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase;
      margin-bottom: 20px;
    }
    h1 { font-size: clamp(36px, 5vw, 52px); font-weight: 600; line-height: 1.1; letter-spacing: -0.02em; margin-bottom: 16px; }
    .hero p { font-size: 18px; color: var(--muted); max-width: 640px; margin-bottom: 28px; }
    .hero-actions { display: flex; gap: 12px; flex-wrap: wrap; }
    
    /* Buttons */
    .btn {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 16px 28px; border-radius: 14px; font-size: 15px; font-weight: 600;
      cursor: pointer; border: none; font-family: inherit;
      transition: all 0.25s ease;
    }
    .btn-primary { background: var(--sage); color: white; box-shadow: 0 4px 16px rgba(74,124,89,0.3); }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(74,124,89,0.35); }
    .btn-secondary { background: white; color: var(--text); border: 1px solid var(--line); }
    .btn-secondary:hover { background: var(--bg); }
    .btn-coral { background: var(--coral); color: white; box-shadow: 0 4px 16px rgba(224,122,95,0.3); }
    .btn-coral:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(224,122,95,0.35); }

    /* Layout */
    main { padding: 32px 0 80px; }
    .grid { display: grid; grid-template-columns: 400px 1fr; gap: 32px; align-items: start; }
    @media (max-width: 1024px) { .grid { grid-template-columns: 1fr; } .sidebar { position: static !important; } }

    /* Cards */
    .card { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--line); }
    .card-head { padding: 18px 22px; border-bottom: 1px solid var(--line); display: flex; justify-content: space-between; align-items: center; }
    .card-title { font-size: 12px; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); }
    .card-body { padding: 22px; }

    /* Sidebar */
    .sidebar { position: sticky; top: 88px; }
    .sec { margin-bottom: 20px; }
    .sec-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .sec-title { font-size: 13px; font-weight: 600; color: var(--muted); display: flex; align-items: center; gap: 8px; }
    .sec-badge { background: var(--bg); padding: 4px 10px; border-radius: 12px; font-size: 11px; }
    .inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .inputs.single { grid-template-columns: 1fr; }
    .field input {
      width: 100%; padding: 14px 16px; border: 1px solid var(--line);
      border-radius: 12px; font-size: 14px; background: #FFFDFC;
      transition: all 0.2s;
    }
    .field input:focus { outline: none; border-color: var(--sage); box-shadow: 0 0 0 4px var(--sage-light); background: white; }
    .field input::placeholder { color: #9CA3AF; }
    .checkbox { display: flex; align-items: center; gap: 10px; padding: 14px 16px; background: #FFFDFC; border-radius: 12px; border: 1px solid var(--line); font-size: 14px; }
    .expand-btn { color: var(--sage); font-weight: 600; font-size: 14px; cursor: pointer; margin-top: 8px; }
    .advanced { display: none; margin-top: 16px; }
    .advanced.show { display: block; }

    /* Results */
    .results { display: grid; gap: 28px; }
    .empty { text-align: center; padding: 60px 24px; }
    .empty-icon { font-size: 56px; margin-bottom: 16px; }
    .empty h3 { font-size: 20px; font-weight: 600; margin-bottom: 8px; }
    .empty p { color: var(--muted); max-width: 400px; margin: 0 auto; }

    /* Section Headers */
    .section-header { margin-bottom: 20px; }
    .section-header h2 { font-size: 24px; font-weight: 600; margin-bottom: 6px; }
    .section-header p { color: var(--muted); font-size: 15px; }

    /* Collapsible Sections */
    .collapsible { margin-bottom: 24px; }
    .collapsible-header {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 20px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .collapsible-header:hover { box-shadow: var(--shadow); }
    .collapsible-header h3 { font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 12px; }
    .collapsible-header .icon { font-size: 24px; }
    .collapsible-header .arrow { color: var(--muted); transition: transform 0.2s; }
    .collapsible.open .collapsible-header .arrow { transform: rotate(180deg); }
    .collapsible-body {
      display: none;
      background: var(--card);
      border: 1px solid var(--line);
      border-top: none;
      border-radius: 0 0 var(--radius) var(--radius);
      padding: 24px;
      margin-top: -20px;
    }
    .collapsible.open .collapsible-body { display: block; }

    /* Executive Summary */
    .exec-summary {
      background: linear-gradient(135deg, #F8FAF9 0%, #F0F4F2 100%);
      border: 2px solid rgba(74,124,89,0.2);
      border-radius: var(--radius);
      padding: 32px;
      margin-bottom: 28px;
    }
    .exec-summary h2 { font-size: 28px; font-weight: 600; margin-bottom: 8px; }
    .exec-summary > p { color: var(--muted); margin-bottom: 24px; }
    .exec-stats { display: flex; justify-content: center; gap: 48px; margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid rgba(74,124,89,0.15); }
    .stat-num { font-size: 32px; font-weight: 700; color: var(--sage); }
    .stat-label { font-size: 13px; color: var(--muted); margin-top: 4px; }
    
    .key-findings { margin-bottom: 20px; }
    .key-findings h4 { font-size: 14px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 12px; }
    .finding-item {
      display: flex; align-items: center; gap: 12px;
      padding: 12px 16px; background: white; border-radius: 12px;
      margin-bottom: 8px; border: 1px solid var(--line);
    }
    .finding-badge {
      padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 600; text-transform: uppercase;
    }
    .badge-high { background: var(--coral-light); color: #A4513E; }
    .badge-moderate { background: var(--gold-light); color: #9A7B3C; }
    .badge-normal { background: var(--sage-light); color: var(--sage); }
    .badge-review { background: var(--blue-light); color: var(--blue); }
    
    .action-items { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; }
    .action-item {
      padding: 16px; background: white; border-radius: 12px; border: 1px solid var(--line);
    }
    .action-item h5 { font-size: 11px; font-weight: 600; color: var(--muted); text-transform: uppercase; margin-bottom: 6px; }
    .action-priority { display: inline-block; font-size: 10px; padding: 2px 8px; border-radius: 6px; margin-left: 8px; }
    .priority-high { background: var(--coral-light); color: #A4513E; }
    .priority-moderate { background: var(--gold-light); color: #9A7B3C; }

    /* Coverage Dashboard */
    .coverage-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; }
    .coverage-item { background: white; border: 1px solid var(--line); border-radius: 14px; padding: 18px; }
    .coverage-item h4 { font-size: 13px; font-weight: 600; text-transform: capitalize; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
    .coverage-bar { height: 8px; background: var(--bg); border-radius: 4px; overflow: hidden; margin-bottom: 8px; }
    .coverage-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
    .coverage-fill.high { background: var(--sage); }
    .coverage-fill.medium { background: var(--gold); }
    .coverage-fill.low { background: var(--coral); }
    .coverage-stats { display: flex; justify-content: space-between; font-size: 12px; color: var(--muted); }
    .coverage-detail { margin-top: 10px; font-size: 11px; }
    .coverage-detail .provided { color: var(--sage); }
    .coverage-detail .missing { color: var(--muted); }

    /* Unlock Opportunities */
    .unlock-grid { display: grid; gap: 12px; }
    .unlock-item {
      background: white; border: 1px solid var(--line); border-radius: 14px;
      padding: 18px; display: flex; align-items: flex-start; gap: 16px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .unlock-item:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
    .unlock-icon {
      width: 44px; height: 44px; border-radius: 12px;
      background: var(--purple-light); color: var(--purple);
      display: grid; place-items: center; font-size: 20px; flex-shrink: 0;
    }
    .unlock-content h4 { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
    .unlock-content p { font-size: 13px; color: var(--muted); margin-bottom: 8px; }
    .unlock-outputs { display: flex; flex-wrap: wrap; gap: 6px; }
    .unlock-output {
      font-size: 11px; padding: 4px 8px; border-radius: 6px;
      background: var(--blue-light); color: var(--blue);
    }
    .unlock-output.proxy { background: var(--purple-light); color: var(--purple); }
    .impact-score { font-size: 12px; font-weight: 600; color: var(--sage); margin-top: 8px; }

    /* Priority Findings */
    .priority-grid { display: grid; gap: 14px; }
    .priority-item {
      background: white; border: 1px solid var(--line); border-radius: 14px;
      padding: 18px; display: flex; align-items: flex-start; gap: 16px;
    }
    .priority-rank {
      width: 36px; height: 36px; border-radius: 10px;
      background: var(--sage-light); color: var(--sage);
      display: grid; place-items: center; font-weight: 700; font-size: 14px;
    }
    .priority-rank.warning { background: var(--coral-light); color: #A4513E; }
    .priority-content { flex: 1; }
    .priority-content h4 { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
    .priority-value { font-size: 20px; font-weight: 700; color: var(--sage); }
    .priority-value.warn { color: var(--coral); }
    .priority-meta { display: flex; gap: 16px; margin-top: 8px; font-size: 12px; color: var(--muted); }
    .priority-meta span { display: flex; align-items: center; gap: 4px; }
    .priority-citation { font-size: 11px; color: var(--blue); margin-top: 6px; }

    /* Derived Values by Tier */
    .tier-section { margin-bottom: 24px; }
    .tier-header {
      display: flex; align-items: center; gap: 12px;
      padding: 14px 18px; background: var(--bg); border-radius: 12px;
      margin-bottom: 12px;
    }
    .tier-badge {
      padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 600;
    }
    .tier-1 { background: var(--sage-light); color: var(--sage); }
    .tier-2 { background: var(--blue-light); color: var(--blue); }
    .tier-3 { background: var(--purple-light); color: var(--purple); }
    .tier-header h4 { font-size: 14px; font-weight: 600; }
    .tier-count { color: var(--muted); font-size: 13px; margin-left: auto; }
    .tier-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; }
    .tier-item {
      background: white; border: 1px solid var(--line); border-radius: 12px; padding: 16px;
    }
    .tier-item-name { font-size: 12px; color: var(--muted); font-weight: 500; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.03em; }
    .tier-item-value { font-size: 22px; font-weight: 700; margin-bottom: 4px; }
    .tier-item-tag { display: inline-block; padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: 600; }

    /* States Grid */
    .states-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px; }
    .state-card { padding: 22px; display: block; transition: transform 0.2s, box-shadow 0.2s; }
    .state-card:hover { transform: translateY(-4px); box-shadow: 0 12px 32px rgba(0,0,0,0.08); }
    .state-header { display: flex; gap: 16px; margin-bottom: 16px; }
    .state-icon { width: 52px; height: 52px; border-radius: 16px; display: grid; place-items: center; font-size: 22px; flex-shrink: 0; }
    .state-icon.ok { background: var(--sage-light); }
    .state-icon.warn { background: var(--coral-light); }
    .state-name { font-size: 12px; font-weight: 600; color: var(--muted); letter-spacing: 0.05em; text-transform: uppercase; margin-bottom: 4px; }
    .state-value { font-size: 20px; font-weight: 600; text-transform: capitalize; margin-bottom: 6px; }
    .state-factors { font-size: 13px; color: var(--muted); }
    .state-score { display: inline-block; margin-top: 8px; padding: 5px 12px; background: var(--bg); border-radius: 8px; font-size: 12px; font-weight: 600; }
    .state-body { border-top: 1px solid var(--line); padding-top: 16px; }
    .state-section { margin-bottom: 14px; }
    .state-section:last-child { margin-bottom: 0; }
    .state-section-title { font-size: 10px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
    .inputs-grid { display: flex; flex-wrap: wrap; gap: 6px; }
    .input-chip { background: var(--sage-light); border-radius: 8px; padding: 6px 10px; font-size: 12px; display: flex; align-items: center; gap: 4px; }
    .input-chip .name { font-weight: 600; color: var(--sage); }
    .input-chip.supporting { background: var(--bg); }
    .input-chip.supporting .name { color: var(--muted); }
    .derived-grid { display: flex; flex-wrap: wrap; gap: 6px; }
    .derived-chip { background: linear-gradient(135deg, #F0F4FF 0%, #E8EEFF 100%); border: 1px solid rgba(74,124,200,0.2); border-radius: 8px; padding: 6px 10px; font-size: 12px; }
    .derived-chip .name { font-weight: 600; color: #4A6FA5; }
    .derived-chip.warn { background: var(--coral-light); border-color: rgba(224,122,95,0.3); }
    .derived-chip.warn .name { color: #A4513E; }
    .lab-correlation { background: linear-gradient(135deg, #FFF8F5 0%, #FFFAF8 100%); border: 1px solid rgba(224,122,95,0.2); border-radius: 10px; padding: 12px 14px; }
    .lab-correlation-header { font-size: 11px; font-weight: 700; color: var(--coral); margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
    .lab-findings { display: flex; flex-direction: column; gap: 4px; }
    .lab-finding { font-size: 11px; line-height: 1.4; color: var(--text); display: flex; align-items: baseline; gap: 6px; }
    .lab-finding .test { font-weight: 600; color: #A4513E; min-width: 70px; }

    /* Lab Anchoring Section */
    .lab-section h3 { font-size: 22px; font-weight: 600; margin-bottom: 8px; }
    .lab-section > p { color: var(--muted); margin-bottom: 24px; }
    .lab-card { margin-bottom: 16px; transition: transform 0.2s, box-shadow 0.2s; }
    .lab-card:hover { transform: translateY(-3px); }
    .lab-header { padding: 20px 24px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
    .lab-title { display: flex; align-items: center; gap: 14px; }
    .lab-icon { width: 44px; height: 44px; border-radius: 12px; background: var(--sage-light); display: grid; place-items: center; font-size: 20px; }
    .lab-name h4 { font-size: 16px; font-weight: 600; margin-bottom: 2px; }
    .lab-name p { font-size: 13px; color: var(--muted); }
    .lab-status { display: flex; align-items: center; gap: 12px; }
    .pill { padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: capitalize; }
    .pill.ok { background: var(--sage-light); color: var(--sage); }
    .pill.warn { background: var(--coral-light); color: #A4513E; }
    .arrow { color: var(--muted); transition: transform 0.2s; }
    .lab-card.open .arrow { transform: rotate(180deg); }
    .lab-details { display: none; padding: 0 24px 24px; }
    .lab-card.open .lab-details { display: block; }
    .anticipated-box { background: linear-gradient(135deg, #FFF8F5 0%, #FFF3EE 100%); border: 2px solid rgba(224,122,95,0.25); border-radius: 16px; padding: 20px 24px; margin-bottom: 20px; }
    .anticipated-box h5 { font-size: 14px; font-weight: 700; color: var(--coral); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .anticipated-list { list-style: none; }
    .anticipated-list li { padding: 10px 0; border-bottom: 1px solid rgba(224,122,95,0.15); font-size: 15px; line-height: 1.5; }
    .anticipated-list li:last-child { border-bottom: none; }
    .context-box { background: var(--sage-light); border-radius: 12px; padding: 16px 18px; font-size: 14px; color: var(--sage); margin-bottom: 16px; }
    .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 600px) { .action-grid { grid-template-columns: 1fr; } }
    .action-card { background: var(--bg); border-radius: 12px; padding: 16px; }
    .action-card h5 { font-size: 11px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 6px; }
    .disclaimer { background: var(--bg); border-radius: 10px; padding: 12px 16px; font-size: 12px; color: var(--muted); margin-top: 16px; }

    /* Metrics Grid */
    .metrics-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 14px; }
    .metric { background: white; border: 1px solid var(--line); border-radius: 14px; padding: 18px; }
    .metric-label { font-size: 12px; color: var(--muted); font-weight: 600; letter-spacing: 0.05em; text-transform: uppercase; margin-bottom: 6px; }
    .metric-value { font-size: 26px; font-weight: 700; margin-bottom: 6px; }
    .metric-tag { display: inline-block; padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 600; }
    .tag-ok { background: var(--sage-light); color: var(--sage); }
    .tag-warn { background: var(--coral-light); color: #A4513E; }
    .tag-neutral { background: var(--bg); color: var(--muted); }

    /* PDF Button */
    .pdf-btn {
      background: linear-gradient(135deg, var(--coral), #D9694D);
      color: white;
      padding: 14px 24px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
      box-shadow: 0 4px 16px rgba(224,122,95,0.3);
    }
    .pdf-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(224,122,95,0.4); }

    /* Footer */
    footer { border-top: 1px solid var(--line); padding: 40px 0; text-align: center; }
    .footer-links { display: flex; justify-content: center; gap: 24px; margin-bottom: 16px; }
    .footer-links a { color: var(--muted); text-decoration: none; font-size: 14px; }
    .footer-links a:hover { color: var(--text); }
    .disclaimer-footer { max-width: 600px; margin: 0 auto; font-size: 12px; color: var(--muted); }

    .hidden { display: none !important; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: none; } }
    .fade-in { animation: fadeIn 0.4s ease forwards; }
  </style>
</head>
<body>
  <header>
    <div class="container header-inner">
      <div class="brand">
        <div class="brand-mark">MH</div>
        <span>Monitor Health</span>
      </div>
      <nav class="nav">
        <a href="https://monitor-api.abedelhamdan.workers.dev/schema" target="_blank">Schema</a>
        <a href="https://monitor-api.abedelhamdan.workers.dev/citations" target="_blank">Citations</a>
        <span class="version">v3.7.0</span>
      </nav>
    </div>
  </header>

  <section class="hero">
    <div class="container">
      <span class="eyebrow">üß¨ Premium Health Intelligence</span>
      <h1>From partial labs to<br>actionable clarity</h1>
      <p>Enter your biomarkers. We synthesize physiological states and show exactly what traditional lab tests would reveal ‚Äî in plain language you can bring to your clinician.</p>
      <div class="hero-actions">
        <button class="btn btn-primary" onclick="loadDemo()">Load Demo Data</button>
        <button class="btn btn-secondary" onclick="analyze()">Analyze My Labs</button>
      </div>
    </div>
  </section>

  <main>
    <div class="container grid">
      <aside class="sidebar">
        <div class="card">
          <div class="card-head"><span class="card-title">Enter Biomarkers</span></div>
          <div class="card-body">
            <form id="biomarkerForm">
              <div class="sec">
                <div class="sec-head"><span class="sec-title">üíâ Lipids</span><span class="sec-badge">4</span></div>
                <div class="inputs">
                  <div class="field"><input name="total_cholesterol" type="number" placeholder="Total Chol (mg/dL)"></div>
                  <div class="field"><input name="hdl" type="number" placeholder="HDL (mg/dL)"></div>
                  <div class="field"><input name="ldl" type="number" placeholder="LDL (mg/dL)"></div>
                  <div class="field"><input name="triglycerides" type="number" placeholder="Triglycerides (mg/dL)"></div>
                </div>
              </div>
              <div class="sec">
                <div class="sec-head"><span class="sec-title">üç¨ Metabolic</span><span class="sec-badge">4</span></div>
                <div class="inputs">
                  <div class="field"><input name="fasting_glucose" type="number" placeholder="Fasting Glucose (mg/dL)"></div>
                  <div class="field"><input name="fasting_insulin" type="number" step="0.1" placeholder="Fasting Insulin (ŒºIU/mL)"></div>
                  <div class="field"><input name="hba1c" type="number" step="0.1" placeholder="HbA1c (%)"></div>
                  <div class="field"><input name="uric_acid" type="number" step="0.1" placeholder="Uric Acid (mg/dL)"></div>
                </div>
              </div>
              <div class="sec">
                <div class="sec-head"><span class="sec-title">ü¶¥ Kidney & Liver</span><span class="sec-badge">5</span></div>
                <div class="inputs">
                  <div class="field"><input name="creatinine" type="number" step="0.1" placeholder="Creatinine (mg/dL)"></div>
                  <div class="field"><input name="bun" type="number" placeholder="BUN (mg/dL)"></div>
                  <div class="field"><input name="alt" type="number" placeholder="ALT (U/L)"></div>
                  <div class="field"><input name="ast" type="number" placeholder="AST (U/L)"></div>
                  <div class="field"><input name="ggt" type="number" placeholder="GGT (U/L)"></div>
                </div>
              </div>
              <div class="sec">
                <div class="sec-head"><span class="sec-title">üî¨ Inflammatory</span><span class="sec-badge">3</span></div>
                <div class="inputs">
                  <div class="field"><input name="hscrp" type="number" step="0.1" placeholder="hs-CRP (mg/L)"></div>
                  <div class="field"><input name="ferritin" type="number" placeholder="Ferritin (ng/mL)"></div>
                  <div class="field"><input name="homocysteine" type="number" step="0.1" placeholder="Homocysteine (Œºmol/L)"></div>
                </div>
              </div>
              <div class="sec">
                <div class="sec-head"><span class="sec-title">üìä Body & Vitals</span><span class="sec-badge">6</span></div>
                <div class="inputs">
                  <div class="field"><input name="sbp" type="number" placeholder="Systolic BP (mmHg)"></div>
                  <div class="field"><input name="dbp" type="number" placeholder="Diastolic BP (mmHg)"></div>
                  <div class="field"><input name="weight_kg" type="number" step="0.1" placeholder="Weight (kg)"></div>
                  <div class="field"><input name="height_cm" type="number" placeholder="Height (cm)"></div>
                  <div class="field"><input name="waist_cm" type="number" placeholder="Waist (cm)"></div>
                  <div class="field"><input name="age" type="number" placeholder="Age (years)"></div>
                </div>
                <label class="checkbox"><input type="checkbox" name="is_female"> Female</label>
              </div>
              <div class="expand-btn" onclick="toggleAdv()">+ Show Advanced (CBC, Thyroid, Vitamins)</div>
              <div class="advanced" id="advInputs">
                <div class="sec">
                  <div class="sec-head"><span class="sec-title">üß¨ CBC</span></div>
                  <div class="inputs">
                    <div class="field"><input name="hemoglobin" type="number" step="0.1" placeholder="Hemoglobin (g/dL)"></div>
                    <div class="field"><input name="hematocrit" type="number" step="0.1" placeholder="Hematocrit (%)"></div>
                    <div class="field"><input name="wbc" type="number" step="0.1" placeholder="WBC (K/ŒºL)"></div>
                    <div class="field"><input name="platelets" type="number" placeholder="Platelets (K/ŒºL)"></div>
                  </div>
                </div>
                <div class="sec">
                  <div class="sec-head"><span class="sec-title">üß¨ Thyroid</span></div>
                  <div class="inputs">
                    <div class="field"><input name="tsh" type="number" step="0.01" placeholder="TSH (mIU/L)"></div>
                    <div class="field"><input name="ft4" type="number" step="0.1" placeholder="Free T4 (ng/dL)"></div>
                  </div>
                </div>
                <div class="sec">
                  <div class="sec-head"><span class="sec-title">üß¨ Vitamins</span></div>
                  <div class="inputs">
                    <div class="field"><input name="vitamin_d" type="number" placeholder="Vitamin D (ng/mL)"></div>
                    <div class="field"><input name="b12" type="number" placeholder="B12 (pg/mL)"></div>
                  </div>
                </div>
              </div>
            </form>
            <button class="btn btn-primary" style="width:100%;margin-top:20px;" onclick="analyze()">Analyze Biomarkers</button>
            <button class="btn btn-secondary" style="width:100%;margin-top:10px;" onclick="loadDemo()">Load Demo</button>
          </div>
        </div>
      </aside>

      <section class="results">
        <div id="empty" class="card empty">
          <div class="empty-icon">üß™</div>
          <h3>Enter your biomarkers</h3>
          <p>We'll analyze your data and show exactly what traditional lab tests would be expected to reveal.</p>
        </div>
        <div id="resultsContent" class="hidden"></div>
      </section>
    </div>
  </main>

  <footer>
    <div class="container">
      <div class="footer-links">
        <a href="https://monitor-api.abedelhamdan.workers.dev/schema">API Schema</a>
        <a href="https://monitor-api.abedelhamdan.workers.dev/citations">Citations</a>
        <a href="https://github.com/bob56565/monitor-backend">GitHub</a>
      </div>
      <p class="disclaimer-footer">For educational purposes only. Not medical advice. Always consult a qualified healthcare provider.</p>
    </div>
  </footer>

  <script>
    const API = 'https://monitor-api.abedelhamdan.workers.dev';
    let lastAnalysisData = null;
    
    function toggleAdv() {
      document.getElementById('advInputs').classList.toggle('show');
    }
    
    function toggleCollapsible(el) {
      el.closest('.collapsible').classList.toggle('open');
    }
    
    function loadDemo() {
      const d = {total_cholesterol:220,hdl:42,triglycerides:185,fasting_glucose:108,fasting_insulin:15,hba1c:5.9,age:45,creatinine:1.1,weight_kg:85,height_cm:175,waist_cm:98,sbp:138,dbp:88,hscrp:2.8,alt:35,ast:28,ferritin:180,hemoglobin:14.5};
      for (const [k,v] of Object.entries(d)) {
        const el = document.querySelector(`[name="${k}"]`);
        if (el) el.value = v;
      }
      analyze();
    }
    
    async function analyze() {
      const form = document.getElementById('biomarkerForm');
      const data = {};
      new FormData(form).forEach((v,k) => {
        if (k === 'is_female') data[k] = document.querySelector('[name="is_female"]').checked;
        else if (v) data[k] = parseFloat(v);
      });
      if (Object.keys(data).length < 3) return alert('Enter at least 3 values');
      
      try {
        const res = await fetch(`${API}/analyze?mode=a2`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(data)
        });
        const json = await res.json();
        lastAnalysisData = json;
        render(json);
      } catch(e) { alert('Error: ' + e.message); }
    }
    
    function render(data) {
      document.getElementById('empty').classList.add('hidden');
      const el = document.getElementById('resultsContent');
      el.classList.remove('hidden');
      
      let html = '';
      
      // ==================== EXECUTIVE SUMMARY ====================
      html += `
        <div class="exec-summary fade-in">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
            <div>
              <h2>${data.executive_summary?.headline || 'Analysis Complete'}</h2>
              <p>Comprehensive physiological assessment from ${data.cascade_result?.inputs || '‚Äî'} biomarkers</p>
            </div>
            <button class="pdf-btn" onclick="generatePDF()">üìÑ Generate PDF Report</button>
          </div>
          <div class="exec-stats">
            <div><div class="stat-num">${data.cascade_result?.inputs || '‚Äî'}</div><div class="stat-label">Inputs Provided</div></div>
            <div><div class="stat-num">${data.cascade_result?.calculated || '‚Äî'}</div><div class="stat-label">Calculated Values</div></div>
            <div><div class="stat-num">${data.cascade_result?.total || '‚Äî'}</div><div class="stat-label">Total Insights</div></div>
          </div>
      `;
      
      // Key Findings
      if (data.executive_summary?.key_findings?.length) {
        html += `<div class="key-findings"><h4>üéØ Key Findings</h4>`;
        data.executive_summary.key_findings.forEach(f => {
          const sev = f.severity || 'normal';
          const badgeClass = sev === 'high' ? 'badge-high' : sev === 'elevated' || sev === 'review' ? 'badge-moderate' : sev === 'warning' ? 'badge-review' : 'badge-normal';
          html += `<div class="finding-item"><span class="finding-badge ${badgeClass}">${sev}</span><span>${f.finding}</span></div>`;
        });
        html += `</div>`;
      }
      
      // Action Items
      if (data.executive_summary?.action_items?.length) {
        html += `<div style="margin-top: 20px;"><h4 style="font-size: 14px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 12px;">‚ö° Recommended Actions</h4><div class="action-items">`;
        data.executive_summary.action_items.forEach(a => {
          const priClass = a.priority === 'high' ? 'priority-high' : 'priority-moderate';
          html += `<div class="action-item"><h5>Action <span class="action-priority ${priClass}">${a.priority}</span></h5><p>${a.action}</p></div>`;
        });
        html += `</div></div>`;
      }
      
      // Trend Watchlist
      if (data.executive_summary?.trend_watchlist?.length) {
        html += `<div style="margin-top: 20px;"><h4 style="font-size: 14px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 12px;">üìà Trend Watchlist</h4><div style="display: flex; flex-wrap: wrap; gap: 8px;">`;
        data.executive_summary.trend_watchlist.forEach(t => {
          html += `<span style="background: var(--blue-light); color: var(--blue); padding: 6px 12px; border-radius: 8px; font-size: 13px;"><strong>${formatName(t.marker)}:</strong> ${typeof t.current === 'number' ? t.current.toFixed(1) : t.current}</span>`;
        });
        html += `</div></div>`;
      }
      html += `</div>`;
      
      // ==================== COVERAGE DASHBOARD ====================
      if (data.coverage?.by_category) {
        html += `
          <div class="collapsible open fade-in" style="animation-delay: 0.1s;">
            <div class="collapsible-header" onclick="toggleCollapsible(this)">
              <h3><span class="icon">üìä</span> Coverage Dashboard <span style="font-weight: 400; color: var(--muted); margin-left: 12px;">${data.coverage.completeness || 0}% complete</span></h3>
              <span class="arrow">‚ñº</span>
            </div>
            <div class="collapsible-body">
              <p style="color: var(--muted); margin-bottom: 20px;">See which biomarker categories you've provided and where you can add more for deeper insights.</p>
              <div class="coverage-grid">
        `;
        const catIcons = {lipid:'üíâ',glycemic:'üç¨',kidney:'ü¶¥',liver:'ü´Ä',inflammatory:'üî¨',thyroid:'ü¶ã',anemia:'ü©∏',metabolic:'‚öñÔ∏è',cardiac:'‚ù§Ô∏è',nutritional:'üíä',demographics:'üë§'};
        for (const [cat, info] of Object.entries(data.coverage.by_category)) {
          if (!info.provided?.length && !info.missing?.length) continue;
          const pct = Math.round((info.completeness || 0) * 100);
          const fillClass = pct >= 70 ? 'high' : pct >= 40 ? 'medium' : 'low';
          html += `
            <div class="coverage-item">
              <h4>${catIcons[cat] || 'üìã'} ${cat}</h4>
              <div class="coverage-bar"><div class="coverage-fill ${fillClass}" style="width: ${pct}%"></div></div>
              <div class="coverage-stats"><span>${pct}% complete</span><span>${info.provided?.length || 0}/${(info.provided?.length || 0) + (info.missing?.length || 0)}</span></div>
              <div class="coverage-detail">
                ${info.provided?.length ? `<div class="provided">‚úì ${info.provided.map(formatName).join(', ')}</div>` : ''}
                ${info.missing?.length ? `<div class="missing" style="margin-top: 4px;">Missing: ${info.missing.slice(0,3).map(formatName).join(', ')}${info.missing.length > 3 ? '...' : ''}</div>` : ''}
              </div>
            </div>
          `;
        }
        html += `</div></div></div>`;
      }
      
      // ==================== UNLOCK OPPORTUNITIES ====================
      if (data.unlock_opportunities?.length) {
        html += `
          <div class="collapsible fade-in" style="animation-delay: 0.15s;">
            <div class="collapsible-header" onclick="toggleCollapsible(this)">
              <h3><span class="icon">üîì</span> Unlock Opportunities <span style="font-weight: 400; color: var(--muted); margin-left: 12px;">${data.unlock_opportunities.length} available</span></h3>
              <span class="arrow">‚ñº</span>
            </div>
            <div class="collapsible-body">
              <p style="color: var(--muted); margin-bottom: 20px;">Add these tests to unlock more insights. Each input below enables new calculations.</p>
              <div class="unlock-grid">
        `;
        data.unlock_opportunities.slice(0, 8).forEach(u => {
          html += `
            <div class="unlock-item">
              <div class="unlock-icon">üîë</div>
              <div class="unlock-content">
                <h4>Add: ${formatName(u.input)}</h4>
                <p>Unlocks ${u.unlocks_count} new insight${u.unlocks_count > 1 ? 's' : ''}</p>
                <div class="unlock-outputs">
                  ${u.outputs.slice(0, 4).map(o => `<span class="unlock-output ${o.is_proxy ? 'proxy' : ''}">${formatName(o.output)}</span>`).join('')}
                  ${u.outputs.length > 4 ? `<span class="unlock-output">+${u.outputs.length - 4} more</span>` : ''}
                </div>
                <div class="impact-score">Impact Score: ${u.impact_score.toFixed(1)}</div>
              </div>
            </div>
          `;
        });
        html += `</div></div></div>`;
      }
      
      // ==================== PRIORITY FINDINGS ====================
      if (data.priority_findings?.length) {
        html += `
          <div class="collapsible open fade-in" style="animation-delay: 0.2s;">
            <div class="collapsible-header" onclick="toggleCollapsible(this)">
              <h3><span class="icon">üéØ</span> Priority Findings <span style="font-weight: 400; color: var(--muted); margin-left: 12px;">Top ${Math.min(data.priority_findings.length, 15)}</span></h3>
              <span class="arrow">‚ñº</span>
            </div>
            <div class="collapsible-body">
              <p style="color: var(--muted); margin-bottom: 20px;">Findings ranked by clinical significance, confidence, and actionability.</p>
              <div class="priority-grid">
        `;
        data.priority_findings.slice(0, 15).forEach((f, i) => {
          const isWarn = f.interpretation?.risk === 'high' || f.interpretation?.risk === 'elevated' || 
                        (typeof f.value === 'object' && ['elevated', 'likely_resistant', 'strained'].includes(f.value?.state));
          const displayVal = typeof f.value === 'object' ? (f.value.state || f.value.likelihood || JSON.stringify(f.value)) : 
                            (typeof f.value === 'number' ? f.value.toFixed(2) : f.value);
          const conf = f.confidence?.score || f.confidence || 0;
          html += `
            <div class="priority-item">
              <div class="priority-rank ${isWarn ? 'warning' : ''}">${i + 1}</div>
              <div class="priority-content">
                <h4>${formatName(f.name)}</h4>
                <div class="priority-value ${isWarn ? 'warn' : ''}">${displayVal}</div>
                <div class="priority-meta">
                  <span>üéØ Confidence: ${(conf * 100).toFixed(0)}%</span>
                  <span>üìä Tier: ${f.tier || 'derived'}</span>
                  ${f.interpretation?.risk ? `<span>‚ö†Ô∏è Risk: ${f.interpretation.risk}</span>` : ''}
                </div>
                ${f.citation ? `<div class="priority-citation">üìö ${f.citation.source}</div>` : ''}
              </div>
            </div>
          `;
        });
        html += `</div></div></div>`;
      }
      
      // ==================== PHYSIOLOGICAL STATES ====================
      if (data.physiological_states) {
        const evaluatedStates = Object.entries(data.physiological_states).filter(([k, s]) => s.evaluated);
        if (evaluatedStates.length) {
          html += `
            <div class="collapsible open fade-in" style="animation-delay: 0.25s;">
              <div class="collapsible-header" onclick="toggleCollapsible(this)">
                <h3><span class="icon">ü´Ä</span> Physiological States <span style="font-weight: 400; color: var(--muted); margin-left: 12px;">${evaluatedStates.length} assessed</span></h3>
                <span class="arrow">‚ñº</span>
              </div>
              <div class="collapsible-body">
                <p style="color: var(--muted); margin-bottom: 20px;">Each state synthesizes multiple biomarkers into an overall health assessment.</p>
                <div class="states-grid">
          `;
          for (const [k, s] of evaluatedStates) {
            const cls = s.score > 70 ? 'ok' : 'warn';
            const ico = s.score > 70 ? '‚úì' : '!';
            
            let inputsHtml = '';
            if (s.inputs_used && Object.keys(s.inputs_used).length > 0) {
              inputsHtml = '<div class="inputs-grid">';
              for (const [name, info] of Object.entries(s.inputs_used)) {
                const chipCls = info.role === 'supporting' ? 'supporting' : '';
                const unit = info.unit || '';
                const val = typeof info.value === 'object' ? JSON.stringify(info.value) : info.value;
                inputsHtml += `<div class="input-chip ${chipCls}"><span class="name">${formatName(name)}:</span><span class="val">${val}${unit ? ' ' + unit : ''}</span></div>`;
              }
              inputsHtml += '</div>';
            }
            
            let derivedHtml = '';
            if (s.derived_outputs && Object.keys(s.derived_outputs).length > 0) {
              derivedHtml = '<div class="derived-grid">';
              for (const [name, info] of Object.entries(s.derived_outputs)) {
                const isWarn = info.interpretation?.risk === 'high' || info.interpretation?.risk === 'elevated';
                const val = typeof info.value === 'object' ? (info.value.state || JSON.stringify(info.value)) : info.value;
                derivedHtml += `<div class="derived-chip ${isWarn ? 'warn' : ''}"><span class="name">${formatName(name)}:</span><span class="val">${typeof val === 'number' ? val.toFixed(2) : val}</span></div>`;
              }
              derivedHtml += '</div>';
            }
            
            let labHtml = '';
            if (s.anticipated_labs?.findings?.length > 0) {
              labHtml = `
                <div class="lab-correlation">
                  <div class="lab-correlation-header">üî¨ Anticipated Traditional Labs</div>
                  <div class="lab-findings">
                    ${s.anticipated_labs.findings.slice(0, 4).map(f => `
                      <div class="lab-finding">
                        <span class="test">${f.test}:</span>
                        <span class="expected">${f.anticipated}</span>
                      </div>
                    `).join('')}
                  </div>
                </div>
              `;
            }
            
            html += `
              <div class="card state-card">
                <div class="state-header">
                  <div class="state-icon ${cls}">${ico}</div>
                  <div>
                    <div class="state-name">${s.name}</div>
                    <div class="state-value">${(s.state||'').replace(/_/g,' ')}</div>
                    <div class="state-factors">${(s.factors||[]).slice(0,2).join(' ‚Ä¢ ')||'No concerns'}</div>
                    <div class="state-score">Score: ${s.score}/100</div>
                  </div>
                </div>
                <div class="state-body">
                  ${inputsHtml ? `<div class="state-section"><div class="state-section-title"><span class="icon">üìä</span>Inputs Used</div>${inputsHtml}</div>` : ''}
                  ${derivedHtml ? `<div class="state-section"><div class="state-section-title"><span class="icon">‚ö°</span>Calculated Values</div>${derivedHtml}</div>` : ''}
                  ${labHtml ? `<div class="state-section"><div class="state-section-title"><span class="icon">üß™</span>Traditional Lab Correlation</div>${labHtml}</div>` : ''}
                </div>
              </div>
            `;
          }
          html += `</div></div></div>`;
        }
      }
      
      // ==================== DERIVED VALUES BY TIER ====================
      if (data.derived_by_tier) {
        html += `
          <div class="collapsible fade-in" style="animation-delay: 0.3s;">
            <div class="collapsible-header" onclick="toggleCollapsible(this)">
              <h3><span class="icon">üìê</span> All Derived Values by Tier</h3>
              <span class="arrow">‚ñº</span>
            </div>
            <div class="collapsible-body">
        `;
        
        // Tier 1: Direct Measures
        if (data.derived_by_tier.tier1_direct?.length) {
          html += `
            <div class="tier-section">
              <div class="tier-header">
                <span class="tier-badge tier-1">Tier 1</span>
                <h4>Direct Measures</h4>
                <span class="tier-count">${data.derived_by_tier.tier1_direct.length} values</span>
              </div>
              <div class="tier-grid">
          `;
          data.derived_by_tier.tier1_direct.forEach(d => {
            const val = typeof d.value === 'number' ? d.value.toFixed(2) : d.value;
            const risk = d.interpretation?.risk;
            const tagClass = risk === 'high' || risk === 'elevated' ? 'tag-warn' : risk === 'normal' || risk === 'optimal' ? 'tag-ok' : 'tag-neutral';
            html += `
              <div class="tier-item">
                <div class="tier-item-name">${formatName(d.name)}</div>
                <div class="tier-item-value">${val}</div>
                ${risk ? `<span class="tier-item-tag ${tagClass}">${risk}</span>` : ''}
              </div>
            `;
          });
          html += `</div></div>`;
        }
        
        // Tier 2: Derived Calculations
        const tier2 = [...(data.derived_by_tier.tier2_derived || []), ...(data.derived_by_tier.other || [])];
        if (tier2.length) {
          html += `
            <div class="tier-section">
              <div class="tier-header">
                <span class="tier-badge tier-2">Tier 2</span>
                <h4>Derived Calculations</h4>
                <span class="tier-count">${tier2.length} values</span>
              </div>
              <div class="tier-grid">
          `;
          tier2.forEach(d => {
            const val = typeof d.value === 'number' ? d.value.toFixed(2) : 
                       (typeof d.value === 'object' ? (d.value.state || d.value.diagnosis || JSON.stringify(d.value)) : d.value);
            const risk = d.interpretation?.risk;
            const tagClass = risk === 'high' || risk === 'elevated' ? 'tag-warn' : risk === 'normal' || risk === 'optimal' || risk === 'low' ? 'tag-ok' : 'tag-neutral';
            html += `
              <div class="tier-item">
                <div class="tier-item-name">${formatName(d.name)}</div>
                <div class="tier-item-value">${val}</div>
                ${risk ? `<span class="tier-item-tag ${tagClass}">${risk}</span>` : ''}
              </div>
            `;
          });
          html += `</div></div>`;
        }
        
        // Tier 3: Physiological Proxies
        if (data.derived_by_tier.tier3_proxy?.length) {
          html += `
            <div class="tier-section">
              <div class="tier-header">
                <span class="tier-badge tier-3">Tier 3</span>
                <h4>Physiological Proxies</h4>
                <span class="tier-count">${data.derived_by_tier.tier3_proxy.length} values</span>
              </div>
              <div class="tier-grid">
          `;
          data.derived_by_tier.tier3_proxy.forEach(d => {
            const val = typeof d.value === 'object' ? (d.value.state || d.value.likelihood || JSON.stringify(d.value)) : d.value;
            const isWarn = typeof d.value === 'object' && ['elevated', 'likely_resistant', 'strained', 'deficient'].includes(d.value?.state);
            html += `
              <div class="tier-item">
                <div class="tier-item-name">${formatName(d.name)}</div>
                <div class="tier-item-value" style="font-size: 16px;">${val}</div>
                <span class="tier-item-tag ${isWarn ? 'tag-warn' : 'tag-ok'}">${isWarn ? 'Review' : 'OK'}</span>
              </div>
            `;
          });
          html += `</div></div>`;
        }
        
        html += `</div></div>`;
      }
      
      // ==================== LAB ANCHORING ====================
      if (data.lab_anchoring?.detailed_correlations && Object.keys(data.lab_anchoring.detailed_correlations).length) {
        html += `
          <div class="collapsible fade-in lab-section" style="animation-delay: 0.35s;">
            <div class="collapsible-header" onclick="toggleCollapsible(this)">
              <h3><span class="icon">üß¨</span> Lab Correlation Guide</h3>
              <span class="arrow">‚ñº</span>
            </div>
            <div class="collapsible-body">
              <p style="color: var(--muted); margin-bottom: 24px;">Click each finding to see exactly what traditional lab tests would be expected to reveal.</p>
        `;
        for (const [name, anchor] of Object.entries(data.lab_anchoring.detailed_correlations)) {
          const result = anchor.your_result || 'unknown';
          const cls = result.includes('resistant') || result.includes('elevated') || result.includes('strained') || result.includes('deficient') ? 'warn' : 'ok';
          html += `
            <div class="card lab-card" onclick="this.classList.toggle('open')">
              <div class="lab-header">
                <div class="lab-title">
                  <div class="lab-icon">üß¨</div>
                  <div class="lab-name">
                    <h4>${anchor.proxy}</h4>
                    <p>${anchor.interpretation}</p>
                  </div>
                </div>
                <div class="lab-status">
                  <span class="pill ${cls}">${result.replace(/_/g,' ')}</span>
                  <span class="arrow">‚ñº</span>
                </div>
              </div>
              <div class="lab-details">
                ${anchor.anticipated_findings?.length ? `
                  <div class="anticipated-box">
                    <h5>üéØ Anticipated Traditional Lab Values</h5>
                    <ul class="anticipated-list">
                      ${anchor.anticipated_findings.map(f => `<li>${f}</li>`).join('')}
                    </ul>
                  </div>
                ` : ''}
                <div class="context-box"><strong>Clinical Context:</strong> ${anchor.clinical_context || 'N/A'}</div>
                <div class="action-grid">
                  <div class="action-card">
                    <h5>To Confirm</h5>
                    <p>${anchor.to_confirm_this_finding || 'Consult your healthcare provider'}</p>
                  </div>
                  <div class="action-card">
                    <h5>What You Can Do</h5>
                    <p>${anchor.what_you_can_do || 'Discuss with your clinician'}</p>
                  </div>
                </div>
                <div class="disclaimer">‚ö†Ô∏è ${anchor.important_note || 'This is a physiological pattern inference, not a diagnosis.'}</div>
              </div>
            </div>
          `;
        }
        html += `</div></div>`;
      }
      
      // ==================== KEY METRICS ====================
      const metrics = ['bmi','homa_ir','egfr','ldl','hdl','triglycerides','fasting_glucose','hba1c'];
      const shown = metrics.filter(m => data.values?.[m] !== undefined && typeof data.values[m] === 'number');
      if (shown.length) {
        html += `
          <div class="fade-in" style="animation-delay: 0.4s;">
            <div class="section-header"><h2>Key Metrics</h2></div>
            <div class="metrics-grid">
        `;
        for (const m of shown) {
          const v = data.values[m];
          const display = v > 100 ? Math.round(v) : v.toFixed(1);
          const interp = getInterp(m, v);
          html += `
            <div class="metric">
              <div class="metric-label">${formatName(m)}</div>
              <div class="metric-value">${display}</div>
              <span class="metric-tag tag-${interp.cls}">${interp.label}</span>
            </div>
          `;
        }
        html += `</div></div>`;
      }
      
      el.innerHTML = html;
    }
    
    function formatName(n) {
      const names = {bmi:'BMI',homa_ir:'HOMA-IR',egfr:'eGFR',ldl:'LDL',hdl:'HDL',triglycerides:'Triglycerides',fasting_glucose:'Fasting Glucose',hba1c:'HbA1c',hscrp:'hs-CRP',alt:'ALT',ast:'AST',ggt:'GGT',tsh:'TSH',ft4:'Free T4',total_cholesterol:'Total Cholesterol',fasting_insulin:'Fasting Insulin',creatinine:'Creatinine',bun:'BUN',sbp:'Systolic BP',dbp:'Diastolic BP',waist_cm:'Waist',weight_kg:'Weight',height_cm:'Height',age:'Age',tg_hdl_ratio:'TG/HDL Ratio',tyg_index:'TyG Index',castelli_1:'Castelli I',castelli_2:'Castelli II',atherogenic_index:'Atherogenic Index',pulse_pressure:'Pulse Pressure',nlr:'NLR',plr:'PLR',fib4:'FIB-4',insulin_sensitivity_proxy:'Insulin Sensitivity',inflammatory_burden_proxy:'Inflammatory Burden',cv_resilience_proxy:'CV Resilience',metabolic_stress_state:'Metabolic Stress',hepatic_stress_proxy:'Hepatic Stress',kidney_stress_proxy:'Kidney Stress',mets_likelihood:'MetS Likelihood',non_hdl:'Non-HDL',vldl:'VLDL',map:'MAP'};
      return names[n] || n.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }
    
    function getInterp(m, v) {
      const rules = {
        bmi: v => v < 25 ? {cls:'ok',label:'Normal'} : v < 30 ? {cls:'warn',label:'Overweight'} : {cls:'warn',label:'Obese'},
        homa_ir: v => v < 2 ? {cls:'ok',label:'Optimal'} : v < 3 ? {cls:'neutral',label:'Borderline'} : {cls:'warn',label:'Elevated'},
        egfr: v => v > 90 ? {cls:'ok',label:'Normal'} : v > 60 ? {cls:'neutral',label:'Mild ‚Üì'} : {cls:'warn',label:'Reduced'},
        ldl: v => v < 100 ? {cls:'ok',label:'Optimal'} : v < 130 ? {cls:'neutral',label:'Near Optimal'} : {cls:'warn',label:'High'},
        hdl: v => v > 60 ? {cls:'ok',label:'Optimal'} : v > 40 ? {cls:'neutral',label:'Normal'} : {cls:'warn',label:'Low'},
        triglycerides: v => v < 150 ? {cls:'ok',label:'Normal'} : v < 200 ? {cls:'neutral',label:'Borderline'} : {cls:'warn',label:'High'},
        fasting_glucose: v => v < 100 ? {cls:'ok',label:'Normal'} : v < 126 ? {cls:'warn',label:'Prediabetic'} : {cls:'warn',label:'Diabetic'},
        hba1c: v => v < 5.7 ? {cls:'ok',label:'Normal'} : v < 6.5 ? {cls:'warn',label:'Prediabetic'} : {cls:'warn',label:'Diabetic'}
      };
      return rules[m]?.(v) || {cls:'neutral',label:'Measured'};
    }
    
    // ==================== PDF GENERATION ====================
    function generatePDF() {
      if (!lastAnalysisData) {
        alert('Please analyze biomarkers first');
        return;
      }
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const data = lastAnalysisData;
      let y = 20;
      const margin = 20;
      const pageWidth = doc.internal.pageSize.getWidth();
      const contentWidth = pageWidth - 2 * margin;
      
      // Helper functions
      function addPage() {
        doc.addPage();
        y = 20;
      }
      
      function checkPage(needed = 30) {
        if (y + needed > 270) addPage();
      }
      
      function addTitle(text, size = 18) {
        checkPage(20);
        doc.setFontSize(size);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(45, 52, 54);
        doc.text(text, margin, y);
        y += size * 0.6;
      }
      
      function addSubtitle(text) {
        checkPage(15);
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(74, 124, 89);
        doc.text(text, margin, y);
        y += 8;
      }
      
      function addText(text, indent = 0) {
        checkPage(10);
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(45, 52, 54);
        const lines = doc.splitTextToSize(text, contentWidth - indent);
        doc.text(lines, margin + indent, y);
        y += lines.length * 5;
      }
      
      function addBullet(text, indent = 5) {
        checkPage(10);
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(45, 52, 54);
        doc.text('‚Ä¢', margin + indent, y);
        const lines = doc.splitTextToSize(text, contentWidth - indent - 8);
        doc.text(lines, margin + indent + 8, y);
        y += lines.length * 5;
      }
      
      function addLine() {
        checkPage(10);
        doc.setDrawColor(200, 200, 200);
        doc.line(margin, y, pageWidth - margin, y);
        y += 8;
      }
      
      // ==================== HEADER ====================
      doc.setFillColor(74, 124, 89);
      doc.rect(0, 0, pageWidth, 35, 'F');
      doc.setFontSize(22);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(255, 255, 255);
      doc.text('Monitor Health Report', margin, 22);
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.text(`Generated: ${new Date().toLocaleDateString()} | Version 3.7.0`, margin, 30);
      y = 45;
      
      // ==================== EXECUTIVE SUMMARY ====================
      addTitle('Executive Summary');
      addLine();
      
      if (data.executive_summary?.headline) {
        addText(data.executive_summary.headline);
        y += 5;
      }
      
      // Stats
      doc.setFillColor(248, 250, 249);
      doc.roundedRect(margin, y, contentWidth, 25, 3, 3, 'F');
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(100, 100, 100);
      const statsY = y + 10;
      doc.text(`Inputs: ${data.cascade_result?.inputs || 0}`, margin + 15, statsY);
      doc.text(`Calculated: ${data.cascade_result?.calculated || 0}`, margin + 60, statsY);
      doc.text(`Total Insights: ${data.cascade_result?.total || 0}`, margin + 115, statsY);
      y += 35;
      
      // Key Findings
      if (data.executive_summary?.key_findings?.length) {
        addSubtitle('Key Findings');
        data.executive_summary.key_findings.forEach(f => {
          const sev = f.severity === 'high' ? '[HIGH]' : f.severity === 'elevated' ? '[ELEVATED]' : '';
          addBullet(`${sev} ${f.finding}`);
        });
        y += 5;
      }
      
      // Action Items
      if (data.executive_summary?.action_items?.length) {
        addSubtitle('Recommended Actions');
        data.executive_summary.action_items.forEach(a => {
          addBullet(`[${a.priority?.toUpperCase() || 'ACTION'}] ${a.action}`);
        });
        y += 5;
      }
      
      // ==================== PHYSIOLOGICAL STATES ====================
      if (data.physiological_states) {
        const evaluatedStates = Object.entries(data.physiological_states).filter(([k, s]) => s.evaluated);
        if (evaluatedStates.length) {
          addPage();
          addTitle('Physiological States Assessment');
          addLine();
          addText('Each state synthesizes multiple biomarkers into an overall health assessment.');
          y += 8;
          
          evaluatedStates.forEach(([key, state]) => {
            checkPage(40);
            
            // State box
            const stateColor = state.score > 70 ? [74, 124, 89] : [224, 122, 95];
            doc.setFillColor(...stateColor);
            doc.roundedRect(margin, y, contentWidth, 8, 2, 2, 'F');
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(255, 255, 255);
            doc.text(`${state.name}: ${(state.state || '').replace(/_/g, ' ')} (Score: ${state.score}/100)`, margin + 5, y + 5.5);
            y += 12;
            
            // Factors
            if (state.factors?.length) {
              doc.setFontSize(9);
              doc.setFont('helvetica', 'normal');
              doc.setTextColor(100, 100, 100);
              doc.text(`Factors: ${state.factors.slice(0, 3).join(' ‚Ä¢ ')}`, margin + 5, y);
              y += 6;
            }
            
            // Recommended action
            if (state.recommended_action) {
              doc.setFontSize(9);
              doc.setFont('helvetica', 'italic');
              doc.setTextColor(74, 124, 89);
              doc.text(`Action: ${state.recommended_action}`, margin + 5, y);
              y += 6;
            }
            
            y += 8;
          });
        }
      }
      
      // ==================== LAB CORRELATIONS ====================
      if (data.lab_anchoring?.detailed_correlations && Object.keys(data.lab_anchoring.detailed_correlations).length) {
        addPage();
        addTitle('Lab Correlation Guide');
        addLine();
        addText('These findings show what traditional lab tests would be expected to reveal based on your biomarker patterns.');
        y += 8;
        
        for (const [name, anchor] of Object.entries(data.lab_anchoring.detailed_correlations)) {
          checkPage(50);
          
          addSubtitle(anchor.proxy);
          addText(`Your Result: ${(anchor.your_result || 'unknown').replace(/_/g, ' ')}`);
          y += 3;
          addText(`Interpretation: ${anchor.interpretation || ''}`);
          y += 5;
          
          if (anchor.anticipated_findings?.length) {
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(224, 122, 95);
            doc.text('Anticipated Lab Values:', margin, y);
            y += 5;
            
            anchor.anticipated_findings.slice(0, 4).forEach(f => {
              doc.setFontSize(9);
              doc.setFont('helvetica', 'normal');
              doc.setTextColor(80, 80, 80);
              const lines = doc.splitTextToSize(f, contentWidth - 10);
              doc.text(lines, margin + 5, y);
              y += lines.length * 4 + 2;
            });
          }
          
          if (anchor.what_you_can_do) {
            doc.setFontSize(9);
            doc.setFont('helvetica', 'italic');
            doc.setTextColor(74, 124, 89);
            const actionLines = doc.splitTextToSize(`Action: ${anchor.what_you_can_do}`, contentWidth - 5);
            doc.text(actionLines, margin, y);
            y += actionLines.length * 4;
          }
          
          y += 10;
        }
      }
      
      // ==================== PRIORITY FINDINGS ====================
      if (data.priority_findings?.length) {
        addPage();
        addTitle('Priority Findings');
        addLine();
        addText('Findings ranked by clinical significance and confidence.');
        y += 8;
        
        data.priority_findings.slice(0, 12).forEach((f, i) => {
          checkPage(20);
          
          const displayVal = typeof f.value === 'object' ? 
            (f.value.state || f.value.likelihood || JSON.stringify(f.value)) : 
            (typeof f.value === 'number' ? f.value.toFixed(2) : f.value);
          const conf = f.confidence?.score || f.confidence || 0;
          
          doc.setFontSize(10);
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(45, 52, 54);
          doc.text(`${i + 1}. ${formatName(f.name)}`, margin, y);
          
          doc.setFont('helvetica', 'normal');
          doc.text(`Value: ${displayVal}`, margin + 80, y);
          doc.text(`Confidence: ${(conf * 100).toFixed(0)}%`, margin + 130, y);
          
          y += 8;
        });
      }
      
      // ==================== DISCLAIMER ====================
      addPage();
      addTitle('Important Disclaimer');
      addLine();
      
      doc.setFillColor(255, 248, 245);
      doc.roundedRect(margin, y, contentWidth, 50, 3, 3, 'F');
      y += 8;
      
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(165, 81, 62);
      
      const disclaimer = [
        'This report is for educational and informational purposes only.',
        'It is NOT medical advice and should NOT be used for diagnosis or treatment.',
        'The findings are physiological pattern inferences based on biomarker analysis.',
        'Always consult a qualified healthcare provider for medical advice.',
        'This report does not establish a doctor-patient relationship.',
        'Lab values and interpretations should be confirmed with traditional testing.'
      ];
      
      disclaimer.forEach(line => {
        doc.text('‚Ä¢ ' + line, margin + 5, y);
        y += 7;
      });
      
      y += 15;
      
      // Footer
      doc.setFontSize(9);
      doc.setFont('helvetica', 'italic');
      doc.setTextColor(150, 150, 150);
      doc.text('Monitor Health v3.7.0 | https://monitor-demo.abedelhamdan.com', margin, y);
      doc.text(`Report generated: ${new Date().toISOString()}`, margin, y + 5);
      
      // Save
      doc.save(`monitor-health-report-${new Date().toISOString().split('T')[0]}.pdf`);
    }
  </script>
</body>
</html>
